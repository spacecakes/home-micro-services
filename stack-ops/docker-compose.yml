x-common: &common
  restart: unless-stopped

services:
  docker-backup:
    <<: *common
    container_name: docker-backup
    image: alpine:latest
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache rsync py3-pip docker-cli docker-cli-compose curl > /dev/null
        pip install --break-system-packages flask > /dev/null
        echo '0 * * * * curl -sX POST http://localhost:8000/run' | crontab -
        crond -l 2
        python3 /app/web.py
    volumes:
      - /srv/docker:/source
      - nfs-backup-docker:/destination
      - /srv/docker/stack-ops/docker-backup/web.py:/app/web.py:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - 'traefik.enable=false'

  # UPS monitoring (APC NMC via SNMP)
  apcupsd:
    <<: *common
    container_name: apcupsd
    image: apcupsd:latest
    build: /srv/docker/stack-ops/apcupsd
    security_opt:
      - apparmor:unconfined
    ports:
      - '3551:3551' # NIS (apcaccess)
    labels:
      - 'traefik.enable=false'
    volumes:
      - /srv/docker/stack-ops/apcupsd/apcupsd.conf:/etc/apcupsd/apcupsd.conf:ro
      - /run/dbus/system_bus_socket:/run/dbus/system_bus_socket

  ops-dashboard:
    <<: *common
    container_name: ops-dashboard
    image: ops-dashboard:latest
    build: /srv/docker/stack-ops/ops-dashboard
    networks:
      - default
      - traefik-proxy
    labels:
      - 'traefik.http.routers.ops-dashboard.rule=Host(`ops.lundmark.tech`)'
      - 'traefik.http.routers.ops-dashboard.middlewares=authelia@file'
      - 'traefik.http.services.ops-dashboard.loadbalancer.server.port=5000'
      - 'traefik.docker.network=traefik-proxy'

  watchtower:
    <<: *common
    container_name: watchtower
    image: containrrr/watchtower:latest
    environment:
      - WATCHTOWER_CLEANUP=true
    labels:
      - 'traefik.enable=false'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  nfs-backup-docker:
    driver: local
    driver_opts:
      type: nfs
      o: "addr=10.0.1.2,soft,timeo=50,vers=4.1,noatime"
      device: ":/volume1/backup-homeserver/docker"

networks:
  traefik-proxy:
    external: true
