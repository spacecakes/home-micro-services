name: 'homeserver-services'

# Bypass Adguard Home for services that don't need it
x-dns: &default-dns
  - 1.1.1.1 # Cloudflare DNS
  - 8.8.8.8 # Google DNS

services:
  # Server tools
  traefik:
    container_name: traefik
    image: traefik:3.6
    networks:
      - default
      - traefik-proxy
    extra_hosts:
      - 'host.docker.internal:172.17.0.1'
    ports:
      - '443:443'
      - '80:80'
      - '8080:8080'
    labels:
      - 'traefik.http.routers.traefik.rule=Host(`proxy.lundmark.tech`)'
      - 'traefik.http.services.traefik.loadbalancer.server.port=8080'
      - 'com.centurylinklabs.watchtower.enable=false'
    restart: always
    environment:
      - BASIC_AUTH_USERNAME=${BASIC_AUTH_USERNAME}
      - BASIC_AUTH_PASSWORD_HASH=${BASIC_AUTH_PASSWORD_HASH}
      - JOKER_API_MODE=SVC
      - JOKER_USERNAME=${JOKER_DDNS_USERNAME}
      - JOKER_PASSWORD=${JOKER_DDNS_PASSWORD}
    volumes:
      - ${PROJECT_PATH}/data/traefik/letsencrypt:/letsencrypt
      - ${PROJECT_PATH}/traefik/traefik.yml:/traefik.yml
      - ${PROJECT_PATH}/traefik/dynamic.yml:/dynamic.yml
      - /var/run/docker.sock:/var/run/docker.sock

  traefik-deny:
    image: nginx:alpine
    container_name: traefik-deny
    labels:
      - traefik.enable=false
    command: sh -c 'echo "server { listen 80; location / { return 403 \"Access denied\"; } }" > /etc/nginx/conf.d/default.conf && nginx -g "daemon off;"'
    restart: unless-stopped

  traefik-certs-dumper:
    image: ldez/traefik-certs-dumper:v2.9.3
    container_name: traefik-certs-dumper
    labels:
      - traefik.enable=false
    entrypoint: sh -c '
      while ! [ -e /data/acme.json ]
      || ! [ `jq ".[] | .Certificates | length" /data/acme.json | jq -s "add" ` != 0 ]; do
      sleep 1
      ; done
      && traefik-certs-dumper file --version v2 --watch
      --source /data/acme.json --dest /data/certs'
    volumes:
      - ${PROJECT_PATH}/data/traefik/letsencrypt:/data
    network_mode: 'none'

  dockerproxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: dockerproxy
    environment:
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - POST=0
    ports:
      - 127.0.0.1:2375:2375
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

  portainer:
    ports:
      - '9000:9000'
    container_name: portainer
    image: portainer/portainer-ce:latest
    labels:
      - 'traefik.http.routers.portainer.rule=Host(`containers-server.lundmark.tech`)'
      - 'traefik.http.services.portainer.loadbalancer.server.port=9000'
    restart: always
    volumes:
      - ${PROJECT_PATH}/data/portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - traefik

  watchtower:
    container_name: watchtower
    image: containrrr/watchtower:latest
    restart: 'unless-stopped'
    environment:
      - WATCHTOWER_CLEANUP=true
    labels:
      - 'traefik.enable=false'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  uptime-kuma:
    container_name: uptime-kuma
    image: louislam/uptime-kuma:latest
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.uptime-kuma.rule=Host(`status.lundmark.tech`)'
      - 'traefik.http.services.uptime-kuma.loadbalancer.server.port=3001'
    volumes:
      - ${PROJECT_PATH}/data/uptime-kuma:/app/data
    depends_on:
      - traefik

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    environment:
      PGID: ${GID}
      PUID: ${UID}
      HOMEPAGE_ALLOWED_HOSTS: 'lundmark.tech'
      HOMEPAGE_VAR_UNIFI_PASSWORD: ${HOMEPAGE_UNIFI_PASSWORD}
    labels:
      - 'traefik.http.routers.homepage.rule=Host(`lundmark.tech`)'
    volumes:
      # Base config directory (for runtime files like docker.yaml, kubernetes.yaml, etc)
      - ${PROJECT_PATH}/data/homepage/config:/app/config
      # Git-tracked config files (override defaults)
      - ${PROJECT_PATH}/homepage/services.yaml:/app/config/services.yaml:ro
      - ${PROJECT_PATH}/homepage/settings.yaml:/app/config/settings.yaml:ro
      - ${PROJECT_PATH}/homepage/widgets.yaml:/app/config/widgets.yaml:ro
      - ${PROJECT_PATH}/homepage/bookmarks.yaml:/app/config/bookmarks.yaml:ro
      - ${PROJECT_PATH}/homepage/docker.yaml:/app/config/docker.yaml:ro
      # Public assets (git-ignored)
      - ${PROJECT_PATH}/data/homepage/images:/app/public/images
      - ${PROJECT_PATH}/data/homepage/icons:/app/public/icons
    depends_on:
      - traefik
      - dockerproxy

  seerr:
    image: ghcr.io/seerr-team/seerr:latest
    init: true
    container_name: seerr
    environment:
      - LOG_LEVEL=debug
      - TZ=${TZ}
    dns: *default-dns
    volumes:
      - ${PROJECT_PATH}/data/seerr/config:/app/config
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.seerr.rule=Host(`requests.lundmark.tech`)'
    depends_on:
      - traefik
      - sonarr
      - radarr
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 3

  adguardhome:
    container_name: adguardhome
    image: adguard/adguardhome
    ports:
      - 53:53/tcp
      - 53:53/udp
    labels:
      - 'traefik.http.routers.adguardhome.rule=Host(`dns1.lundmark.tech`)'
      - 'traefik.http.services.adguardhome.loadbalancer.server.port=3000'
    volumes:
      - ${PROJECT_PATH}/data/adguardhome/work:/opt/adguardhome/work
      - ${PROJECT_PATH}/data/adguardhome/config:/opt/adguardhome/conf
    restart: always
    depends_on:
      - traefik

  adguardhome-sync:
    image: lscr.io/linuxserver/adguardhome-sync:latest
    container_name: adguardhome-sync
    environment:
      - TZ=${TZ}
      - PUID=${UID}
      - PGID=${GID}
      - CONFIGFILE=/config/adguardhome-sync.yaml
    volumes:
      - ${PROJECT_PATH}/data/adguardhome-sync/config:/config
    ports:
      - 8082:8080
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.adguardhome-sync.rule=Host(`dns-sync.lundmark.tech`)'
    depends_on:
      - adguardhome
      - traefik

  # Home automation
  homeassistant:
    container_name: homeassistant
    image: linuxserver/homeassistant:latest
    network_mode: host
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - PUID=${UID}
      - PGID=${GID}
    labels:
      - 'traefik.http.routers.homeassistant.rule=Host(`home.lundmark.tech`)'
      - 'traefik.http.services.homeassistant.loadbalancer.server.port=8123'
      - 'com.centurylinklabs.watchtower.enable=false'
    volumes:
      - ${PROJECT_PATH}/data/homeassistant:/config
      - ${MOUNTS_PATH}/music:/music
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0
    depends_on:
      - traefik

  homebridge:
    container_name: homebridge
    hostname: homebridge
    image: homebridge/homebridge:latest
    environment:
      - TZ=${TZ}
    network_mode: host
    restart: unless-stopped
    labels:
      - 'traefik.http.services.homebridge.loadbalancer.server.port=8581'
    volumes:
      - ${PROJECT_PATH}/data/homebridge:/homebridge

  scrypted:
    container_name: scrypted
    image: koush/scrypted:latest
    network_mode: host
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.scrypted.rule=Host(`cameras.lundmark.tech`)'
      - 'traefik.http.services.scrypted.loadbalancer.server.port=11080' # Use insecure port; Traefik handles SSL
    volumes:
      - ${PROJECT_PATH}/data/scrypted:/server/volume
    depends_on:
      - traefik

  # Media servers
  plex:
    container_name: plex
    image: linuxserver/plex
    hostname: plex
    network_mode: host
    dns: *default-dns
    environment:
      - PGID=${GID}
      - PUID=${UID}
      - TZ=${TZ}
      # To reclaim, visit https://www.plex.tv/claim/ to get a new token
      # then set it in your .env file and restart the container within 4 minutes.
      - PLEX_CLAIM="${PLEX_CLAIM}"
    devices:
      - /dev/dri:/dev/dri # Intel Quick Sync
    labels:
      - 'traefik.http.routers.plex.rule=Host(`watch.lundmark.tech`)'
      - 'traefik.http.services.plex.loadbalancer.server.port=32400'
    restart: unless-stopped
    volumes:
      - ${PROJECT_PATH}/data/plex:/config
      - ${ROOT_PATH}/temp/plex:/transcode
      - ${MOUNTS_PATH}/media:/media
      - ${MOUNTS_PATH}/home_video:/home_video
      - ${MOUNTS_PATH}/music:/music
      - ${MOUNTS_PATH}/video:/video
    depends_on:
      - traefik

  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    environment:
      - PUID=${UID}
      - PGID=${GID}
      - TZ=${TZ}
    volumes:
      - ${PROJECT_PATH}/data/tautulli:/config
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.tautulli.rule=Host(`stats.lundmark.tech`)'
    depends_on:
      - plex
      - traefik

  sabnzbd:
    container_name: sabnzbd
    image: linuxserver/sabnzbd:latest
    hostname: sabnzbd
    environment:
      - TZ=${TZ}
      - PGID=${GID}
      - PUID=${UID}
    restart: always
    labels:
      - 'traefik.http.routers.sabnzbd.rule=Host(`usenet.lundmark.tech`)'
    volumes:
      - ${PROJECT_PATH}/data/sabnzbd:/config
      - ${ROOT_PATH}/downloads:/downloads
      - ${MOUNTS_PATH}/downloads:/downloads-nas
      - ${MOUNTS_PATH}/media:/media
    depends_on:
      - traefik

  transmission:
    container_name: transmission
    image: linuxserver/transmission:latest
    hostname: transmission
    environment:
      - PGID=${GID}
      - PUID=${UID}
      - TZ=${TZ}
    labels:
      - 'traefik.http.routers.transmission.rule=Host(`torrents.lundmark.tech`)'
      - 'traefik.http.services.transmission.loadbalancer.server.port=9091'
    ports:
      - '51413:51413'
      - '51413:51413/udp'
    restart: unless-stopped
    volumes:
      - ${PROJECT_PATH}/data/transmission:/config
      - ${ROOT_PATH}/downloads:/downloads
      - ${MOUNTS_PATH}/downloads:/downloads-nas
      - ${MOUNTS_PATH}/downloads/seeding:/seeding
      - ${MOUNTS_PATH}/downloads/watch:/watch
    depends_on:
      - traefik

  handbrake:
    container_name: handbrake
    image: jlesage/handbrake
    restart: unless-stopped
    environment:
      - GROUP_ID=${GID}
      - USER_ID=${UID}
      - TZ=${TZ}
      - AUTOMATED_CONVERSION_KEEP_SOURCE=0
    labels:
      - 'traefik.http.routers.handbrake.rule=Host(`encoder.lundmark.tech`)'
    volumes:
      - '${PROJECT_PATH}/data/handbrake:/config:rw'
      - '${ROOT_PATH}/temp/handbrake/watch:/watch:rw'
      - '${ROOT_PATH}/temp/handbrake/output:/output:rw'
      - '${MOUNTS_PATH}/media:/storage:ro'
    depends_on:
      - traefik

  sonarr:
    container_name: sonarr
    image: linuxserver/sonarr:latest
    hostname: sonarr
    dns: *default-dns
    environment:
      - TZ=${TZ}
      - PGID=${GID}
      - PUID=${UID}
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.sonarr.rule=Host(`tv.lundmark.tech`)'
    volumes:
      - ${PROJECT_PATH}/data/sonarr:/config
      - ${ROOT_PATH}/downloads:/downloads
      - ${MOUNTS_PATH}/media:/media
    depends_on:
      - traefik
      - prowlarr
      - nzbhydra
      - sabnzbd
      - transmission

  radarr:
    container_name: radarr
    image: linuxserver/radarr:latest
    hostname: radarr
    dns: *default-dns
    environment:
      - PGID=${GID}
      - PUID=${UID}
      - TZ=${TZ}
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.radarr.rule=Host(`movies.lundmark.tech`)'
    volumes:
      - ${PROJECT_PATH}/data/radarr:/config
      - ${ROOT_PATH}/downloads:/downloads
      - ${MOUNTS_PATH}/media:/media
    depends_on:
      - traefik
      - prowlarr
      - nzbhydra
      - sabnzbd
      - transmission

  bazarr:
    container_name: bazarr
    image: linuxserver/bazarr:latest
    hostname: bazarr
    dns: *default-dns
    environment:
      - TZ=${TZ}
      - PGID=${GID}
      - PUID=${UID}
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.bazarr.rule=Host(`subtitles.lundmark.tech`)'
    volumes:
      - ${PROJECT_PATH}/data/bazarr:/config
      - ${MOUNTS_PATH}/media:/media
    depends_on:
      - traefik

  lidarr:
    container_name: lidarr
    image: linuxserver/lidarr:latest
    hostname: lidarr
    dns: *default-dns
    environment:
      - TZ=${TZ}
      - PGID=${GID}
      - PUID=${UID}
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.lidarr.rule=Host(`music.lundmark.tech`)'
    volumes:
      - ${PROJECT_PATH}/data/lidarr:/config
      - ${ROOT_PATH}/downloads:/downloads
      - ${MOUNTS_PATH}/music:/music
    depends_on:
      - traefik
      - prowlarr
      - nzbhydra
      - sabnzbd
      - transmission

  nzbhydra:
    container_name: nzbhydra
    image: linuxserver/nzbhydra2:latest
    hostname: nzbhydra
    environment:
      - PGID=${GID}
      - PUID=${UID}
      - TZ=${TZ}
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.nzbhydra.rule=Host(`search.lundmark.tech`)'
    volumes:
      - ${PROJECT_PATH}/data/nzbhydra:/config
      - ${ROOT_PATH}/downloads:/downloads
      - ${MOUNTS_PATH}/downloads:/downloads-nas
      - ${MOUNTS_PATH}/media:/media
    depends_on:
      - traefik

  prowlarr:
    container_name: prowlarr
    image: linuxserver/prowlarr:develop
    hostname: prowlarr
    environment:
      - PGID=${GID}
      - PUID=${UID}
      - TZ=${TZ}
    restart: unless-stopped
    labels:
      - 'traefik.http.routers.prowlarr.rule=Host(`indexers.lundmark.tech`)'
    volumes:
      - ${PROJECT_PATH}/data/prowlarr:/config
    depends_on:
      - traefik

networks:
  traefik-proxy:
    external: true
