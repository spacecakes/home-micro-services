x-synology-service: &synology-service
  loadBalancer:
    servers:
      - url: 'https://10.0.1.2:5001'
    passHostHeader: true

http:
  middlewares:
    # auth:
    #   basicauth:
    #     users:
    #       - '{{env "BASIC_AUTH_USERNAME"}}:{{env "BASIC_AUTH_PASSWORD_HASH"}}'

    add-drive-prefix:
      addPrefix:
        prefix: '/drive'

    add-backup-prefix:
      addPrefix:
        prefix: '/backup'

    add-downloads-prefix:
      addPrefix:
        prefix: '/downloads'

    add-files-prefix:
      addPrefix:
        prefix: '/files'

    add-vm-prefix:
      addPrefix:
        prefix: '/vm'

    default-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000

    default-whitelist:
      ipWhiteList:
        sourceRange:
          - '10.0.0.0/24'
          - '192.168.0.0/16'
          - '172.0.0.0/8'

  routers:
    global-headers:
      rule: 'HostRegexp(`{any:.+}`)'
      entryPoints:
        - websecure
      middlewares:
        - default-headers
        - default-whitelist
      service: noop@internal
      priority: 10

    deny-all:
      rule: 'PathPrefix(`/`)'
      entryPoints:
        - web
        - websecure
      service: deny
      priority: 1

    # Synology apps
    dsm:
      rule: 'Host(`dsm.lundmark.tech`)'
      service: synology-dsm

    drive:
      rule: 'Host(`drive.lundmark.tech`)'
      middlewares:
        - add-drive-prefix
      service: synology-drive

    active-backup:
      rule: 'Host(`abb.lundmark.tech`)'
      middlewares:
        - add-backup-prefix
      service: synology-active-backup

    download-station:
      rule: 'Host(`downloads.lundmark.tech`)'
      middlewares:
        - add-downloads-prefix
      service: synology-download-station

    file-station:
      rule: 'Host(`files.lundmark.tech`)'
      middlewares:
        - add-files-prefix
      service: synology-file-station

    vm-manager:
      rule: 'Host(`vm.lundmark.tech`)'
      middlewares:
        - add-vm-prefix
      service: synology-vm

    # Synology containers
    icloudpd:
      rule: 'Host(`icloudpd.lundmark.tech`)'
      service: icloudpd

    icloudpd-shared:
      rule: 'Host(`icloudpd-shared.lundmark.tech`)'
      service: icloudpd-shared

    portainer:
      rule: 'Host(`portainer-homecloud.lundmark.tech`)'
      service: portainer

    adguardhome:
      rule: 'Host(`dns2.lundmark.tech`)'
      service: adguardhome

    # UniFi Controller
    unifi:
      rule: 'Host(`unifi.lundmark.tech`)'
      service: unifi

  services:
    deny:
      loadBalancer:
        servers:
          - url: 'http://traefik-deny:80'

    synology-dsm: *synology-service
    synology-drive: *synology-service
    synology-active-backup: *synology-service
    synology-download-station: *synology-service
    synology-file-station: *synology-service
    synology-vm: *synology-service

    icloudpd:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.2:8080'
        passHostHeader: true

    icloudpd-shared:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.2:8081'
        passHostHeader: true

    portainer:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.2:9000'
        passHostHeader: true

    adguardhome:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.2:3000'
        passHostHeader: true

    unifi:
      loadBalancer:
        servers:
          - url: 'https://10.0.1.1'
        passHostHeader: true
