x-synology-service: &synology-service
  loadBalancer:
    servers:
      - url: 'https://10.0.1.2:5001'
    passHostHeader: true

http:
  middlewares:
    authelia:
      forwardAuth:
        address: 'http://authelia:9091/api/authz/forward-auth'
        trustForwardHeader: true
        authResponseHeaders:
          - 'Remote-User'
          - 'Remote-Groups'
          - 'Remote-Email'
          - 'Remote-Name'

    add-drive-prefix:
      addPrefix:
        prefix: '/drive'

    add-backup-prefix:
      addPrefix:
        prefix: '/backup'

    add-downloads-prefix:
      addPrefix:
        prefix: '/downloads'

    add-files-prefix:
      addPrefix:
        prefix: '/files'

    add-vm-prefix:
      addPrefix:
        prefix: '/vm'

    default-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000

    default-whitelist:
      ipWhiteList:
        sourceRange:
          - '10.0.0.0/24'
          - '192.168.0.0/16'
          - '172.0.0.0/8'

  routers:
    global-headers:
      rule: 'HostRegexp(`{any:.+}`)'
      entryPoints:
        - websecure
      middlewares:
        - default-headers
        - default-whitelist
      service: noop@internal
      priority: 10

    # Synology apps
    dsm:
      rule: 'Host(`dsm.lundmark.tech`)'
      service: synology-dsm

    drive:
      rule: 'Host(`drive.lundmark.tech`)'
      middlewares:
        - add-drive-prefix
      service: synology-drive

    active-backup:
      rule: 'Host(`backup.lundmark.tech`)'
      middlewares:
        - add-backup-prefix
      service: synology-active-backup

    download-station:
      rule: 'Host(`downloads.lundmark.tech`)'
      middlewares:
        - add-downloads-prefix
      service: synology-download-station

    file-station:
      rule: 'Host(`files-nas.lundmark.tech`)'
      middlewares:
        - add-files-prefix
      service: synology-file-station

    vm-manager:
      rule: 'Host(`vm.lundmark.tech`)'
      middlewares:
        - add-vm-prefix
      service: synology-vm

    # Synology containers
    icloudpd:
      rule: 'Host(`icloudpd.lundmark.tech`)'
      middlewares:
        - authelia
      service: icloudpd

    icloudpd-shared:
      rule: 'Host(`icloudpd-shared.lundmark.tech`)'
      middlewares:
        - authelia
      service: icloudpd-shared

    adguardhome:
      rule: 'Host(`dns2.lundmark.tech`)'
      middlewares:
        - authelia
      service: adguardhome

    # Proxmox (no authelia middleware - Proxmox handles auth itself via OIDC)
    proxmox:
      rule: 'Host(`proxmox.lundmark.tech`)'
      service: proxmox

    # Home Assistant OS VM (no authelia - HA handles auth itself)
    homeassistant:
      rule: 'Host(`home.lundmark.tech`)'
      service: homeassistant

    # UniFi Controller
    unifi:
      rule: 'Host(`network.lundmark.tech`)'
      middlewares:
        - authelia
      service: unifi

    # OpenClaw AI assistant VM
    openclaw:
      rule: 'Host(`bot.lundmark.tech`)'
      middlewares:
        - authelia
      service: openclaw

    # APC UPS
    apcups1:
      rule: 'Host(`ups1.lundmark.tech`)'
      middlewares:
        - authelia
      service: apcups1

    apcups2:
      rule: 'Host(`ups2.lundmark.tech`)'
      middlewares:
        - authelia
      service: apcups2

  services:
    synology-dsm: *synology-service
    synology-drive: *synology-service
    synology-active-backup: *synology-service
    synology-download-station: *synology-service
    synology-file-station: *synology-service
    synology-vm: *synology-service

    icloudpd:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.2:8080'
        passHostHeader: true

    icloudpd-shared:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.2:8081'
        passHostHeader: true

    adguardhome:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.2:3000'
        passHostHeader: true

    unifi:
      loadBalancer:
        servers:
          - url: 'https://10.0.1.1'
        passHostHeader: true

    apcups1:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.5'
        passHostHeader: true

    apcups2:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.6'
        passHostHeader: true

    homeassistant:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.7:8123'
        passHostHeader: true

    openclaw:
      loadBalancer:
        servers:
          - url: 'http://10.0.1.9:18789'
        passHostHeader: true

    proxmox:
      loadBalancer:
        servers:
          - url: 'https://10.0.1.3:8006'
        passHostHeader: true
