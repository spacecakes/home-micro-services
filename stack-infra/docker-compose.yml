x-common: &common
  restart: unless-stopped

services:
  # Reverse proxy
  traefik:
    <<: *common
    container_name: traefik
    image: traefik:3.6
    dns:
      - 1.1.1.1 # Cloudflare DNS
      - 8.8.8.8 # Google DNS
    networks:
      - default
      - traefik-proxy
    extra_hosts:
      - 'host.docker.internal:172.17.0.1'
    ports:
      - '443:443'
      - '80:80'
    labels:
      - 'traefik.http.routers.traefik.rule=Host(`proxy.lundmark.tech`)'
      - 'traefik.http.routers.traefik.middlewares=authelia@file'
      - 'traefik.http.services.traefik.loadbalancer.server.port=8080'
      - 'com.centurylinklabs.watchtower.enable=false'
    environment:
      CLOUDFLARE_DNS_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
    volumes:
      - /srv/docker/stack-infra/data/traefik/letsencrypt:/letsencrypt
      - /srv/docker/stack-infra/traefik/traefik.yml:/traefik.yml:ro
      - /srv/docker/stack-infra/traefik/dynamic.yml:/dynamic.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # Docker management
  dockerproxy:
    <<: *common
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: dockerproxy
    environment:
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - NETWORKS=1
      - INFO=1
      - POST=0
    ports:
      - 127.0.0.1:2375:2375
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  portainer:
    <<: *common
    container_name: portainer
    image: portainer/portainer-ce:latest
    ports:
      - '8000:8000' # Edge agent tunnel
    labels:
      - 'traefik.http.routers.portainer.rule=Host(`containers.lundmark.tech`)'
      - 'traefik.http.services.portainer.loadbalancer.server.port=9000'
    volumes:
      - /srv/docker/stack-infra/data/portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - traefik

  dockge:
    <<: *common
    container_name: dockge
    image: louislam/dockge:latest
    labels:
      - 'traefik.http.routers.dockge.rule=Host(`stacks.lundmark.tech`)'
      - 'traefik.http.routers.dockge.middlewares=authelia@file'
      - 'traefik.http.services.dockge.loadbalancer.server.port=5001'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/docker/stack-infra/data/dockge:/app/data
      - /srv/docker:/opt/stacks
    environment:
      DOCKGE_STACKS_DIR: /opt/stacks
    depends_on:
      - traefik

  # Monitoring & dashboard
  uptime-kuma:
    <<: *common
    container_name: uptime-kuma
    image: louislam/uptime-kuma:latest
    labels:
      - 'traefik.http.routers.uptime-kuma.rule=Host(`status.lundmark.tech`)'
      - 'traefik.http.routers.uptime-kuma.middlewares=authelia@file'
      - 'traefik.http.services.uptime-kuma.loadbalancer.server.port=3001'
    volumes:
      - /srv/docker/stack-infra/data/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - traefik

  homepage:
    <<: *common
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    environment:
      PGID: 1000
      PUID: 1000
      HOMEPAGE_ALLOWED_HOSTS: 'lundmark.tech'
      HOMEPAGE_VAR_UNIFI_PASSWORD: ${HOMEPAGE_UNIFI_PASSWORD}
    labels:
      - 'traefik.http.routers.homepage.rule=Host(`lundmark.tech`)'
      - 'traefik.http.routers.homepage.middlewares=authelia@file'
    volumes:
      - /srv/docker/stack-infra/homepage:/app/config
      - /srv/docker/stack-infra/data/homepage/images:/app/public/images:ro
      - /srv/docker/stack-infra/data/homepage/icons:/app/public/icons:ro
    depends_on:
      - traefik
      - dockerproxy

  # File explorer
  filebrowser:
    <<: *common
    container_name: filebrowser
    image: filebrowser/filebrowser:latest
    labels:
      - 'traefik.http.routers.filebrowser.rule=Host(`files-server.lundmark.tech`)'
      - 'traefik.http.routers.filebrowser.middlewares=authelia@file'
      - 'traefik.http.services.filebrowser.loadbalancer.server.port=80'
    volumes:
      - /srv:/srv
      - /srv/docker/stack-infra/data/filebrowser:/config
    depends_on:
      - traefik

networks:
  traefik-proxy:
    external: true
